<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diesel Control Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        .alerta-ultimo { animation: pulse 1.5s infinite; color: #dc2626; font-weight: bold; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .modal-transition { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8 font-sans">

    <div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow-2xl border border-slate-200">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b pb-6">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">üõ†Ô∏è Diesel Control <span class="text-emerald-600">Pro</span></h1>
                <p class="text-sm text-slate-500 font-medium">Gest√£o Profissional de Inje√ß√£o e Pe√ßas</p>
            </div>
            <div class="flex gap-3">
                <button onclick="gerarPDF()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-emerald-700 transition flex items-center gap-2">
                    üìÑ Exportar Relat√≥rio
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-8">
            <div class="md:col-span-5 relative">
                <input id="busca" oninput="renderizar()" type="text" placeholder="üîç Pesquisar pe√ßa em tempo real..." class="w-full p-3 pl-10 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50">
            </div>
            <div class="md:col-span-7 flex gap-2 bg-slate-800 p-2 rounded-xl">
                <input id="nome" type="text" placeholder="Nome da Pe√ßa" class="flex-1 p-2 rounded-lg bg-slate-700 text-white outline-none focus:ring-1 focus:ring-emerald-400">
                <input id="preco" type="number" step="0.01" placeholder="R$ Custo" class="w-24 p-2 rounded-lg bg-slate-700 text-white outline-none">
                <button onclick="adicionar()" class="bg-emerald-500 text-white font-bold px-4 rounded-lg hover:bg-emerald-400 transition">Cadastrar</button>
            </div>
        </div>

        <div class="overflow-hidden rounded-xl border border-slate-200 shadow-sm bg-white">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-800 text-slate-200 uppercase text-xs font-bold">
                    <tr>
                        <th class="p-4">Descri√ß√£o do Item</th>
                        <th class="p-4">Estoque</th>
                        <th class="p-4">Unit√°rio</th>
                        <th class="p-4">Subtotal</th>
                        <th class="p-4 text-center">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="lista-estoque" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>

    <div id="modalMovimentacao" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-transition scale-95 opacity-0" id="modalContent">
            <div id="modalHeader" class="p-4 text-white font-bold text-lg flex justify-between items-center">
                <span id="modalTitulo">Movimenta√ß√£o</span>
                <button onclick="fecharModal()" class="text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">Quantidade:</label>
                    <input id="modalQtd" type="number" class="w-full p-3 border rounded-xl outline-none focus:ring-2" value="1">
                </div>
                <div id="campoDestino">
                    <label class="block text-sm font-bold text-slate-700 mb-1">Destino:</label>
                    <select id="modalDestino" onchange="toggleIdentificacao()" class="w-full p-3 border rounded-xl outline-none focus:ring-2">
                        <option value="P√°tio">Uso no P√°tio</option>
                        <option value="Caminh√£o">Caminh√£o / Cliente</option>
                    </select>
                </div>
                <div id="campoIdentificacao" class="hidden">
                    <label class="block text-sm font-bold text-slate-700 mb-1">Placa ou Cliente:</label>
                    <input id="modalIdentificacao" type="text" placeholder="Ex: ABC-1234 / Jean" class="w-full p-3 border rounded-xl outline-none focus:ring-2">
                </div>
                <button id="btnConfirmar" class="w-full p-4 rounded-xl text-white font-black uppercase tracking-widest transition shadow-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // MANT√âM AS MESMAS CHAVES PARA N√ÉO PERDER DADOS
        let estoque = JSON.parse(localStorage.getItem('meuEstoque')) || [];
        let historico = JSON.parse(localStorage.getItem('meuHistorico')) || [];
        let indexAtual = null;
        let tipoAtual = null;

        function registrarMovimentacao(nome, qtd, tipo, detalhes = "") {
            historico.push({
                data: new Date().toLocaleDateString('pt-BR'),
                hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
                nome, qtd, tipo, detalhes
            });
            localStorage.setItem('meuHistorico', JSON.stringify(historico));
        }

        function renderizar() {
            const lista = document.getElementById('lista-estoque');
            const termoBusca = document.getElementById('busca').value.toLowerCase();
            lista.innerHTML = '';

            estoque.forEach((item, index) => {
                if (item.nome.toLowerCase().includes(termoBusca)) {
                    const subtotal = item.qtd * item.preco;
                    const alerta = item.qtd <= 1 ? 'alerta-ultimo' : 'text-slate-700';

                    lista.innerHTML += `
                        <tr class="hover:bg-slate-50 transition">
                            <td class="p-4 font-bold text-slate-800">${item.nome}</td>
                            <td class="p-4">
                                <span class="${alerta} text-lg">${item.qtd}</span>
                                ${item.qtd <= 1 ? '<span class="text-[10px] block text-red-500 font-black italic">BAIXO ESTOQUE</span>' : ''}
                            </td>
                            <td class="p-4 text-slate-500 font-medium">R$ ${item.preco.toFixed(2)}</td>
                            <td class="p-4 font-bold text-emerald-600">R$ ${subtotal.toFixed(2)}</td>
                            <td class="p-4">
                                <div class="flex justify-center gap-2">
                                    <button onclick="abrirModal(${index}, 'Sa√≠da')" class="bg-red-500 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-red-600 shadow-md transition">‚Üì Sa√≠da</button>
                                    <button onclick="abrirModal(${index}, 'Entrada')" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-blue-700 shadow-md transition">‚Üë Entrada</button>
                                    <button onclick="remover(${index})" class="ml-4 text-slate-300 hover:text-red-500 transition">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>`;
                }
            });
            localStorage.setItem('meuEstoque', JSON.stringify(estoque));
        }

        function adicionar() {
            const n = document.getElementById('nome').value.trim();
            const p = parseFloat(document.getElementById('preco').value);
            if(n && !isNaN(p)) {
                estoque.push({nome: n, qtd: 0, preco: p});
                registrarMovimentacao(n, 0, "Cadastro", "Item novo");
                document.getElementById('nome').value = '';
                document.getElementById('preco').value = '';
                renderizar();
            }
        }

        // --- L√ìGICA DO MODAL PROFISSIONAL ---
        function abrirModal(index, tipo) {
            indexAtual = index;
            tipoAtual = tipo;
            const item = estoque[index];
            const modal = document.getElementById('modalMovimentacao');
            const content = document.getElementById('modalContent');
            const header = document.getElementById('modalHeader');
            const btn = document.getElementById('btnConfirmar');
            
            document.getElementById('modalTitulo').innerText = `${tipo}: ${item.nome}`;
            document.getElementById('modalQtd').value = 1;
            document.getElementById('modalIdentificacao').value = '';
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
            }, 10);

            if (tipo === 'Sa√≠da') {
                header.className = "p-4 text-white font-bold text-lg flex justify-between items-center bg-red-600";
                btn.className = "w-full p-4 rounded-xl text-white font-black uppercase bg-red-600 hover:bg-red-700 transition";
                document.getElementById('campoDestino').classList.remove('hidden');
                toggleIdentificacao();
            } else {
                header.className = "p-4 text-white font-bold text-lg flex justify-between items-center bg-blue-600";
                btn.className = "w-full p-4 rounded-xl text-white font-black uppercase bg-blue-600 hover:bg-blue-700 transition";
                document.getElementById('campoDestino').classList.add('hidden');
                document.getElementById('campoIdentificacao').classList.add('hidden');
            }
            
            btn.onclick = confirmarMovimentacao;
        }

        function toggleIdentificacao() {
            const destino = document.getElementById('modalDestino').value;
            const campoId = document.getElementById('campoIdentificacao');
            destino === 'Caminh√£o' ? campoId.classList.remove('hidden') : campoId.classList.add('hidden');
        }

        function fecharModal() {
            const modal = document.getElementById('modalMovimentacao');
            const content = document.getElementById('modalContent');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function confirmarMovimentacao() {
            const item = estoque[indexAtual];
            const qtd = parseInt(document.getElementById('modalQtd').value);
            const destino = document.getElementById('modalDestino').value;
            const ident = document.getElementById('modalIdentificacao').value;

            if (isNaN(qtd) || qtd <= 0) return alert("Por favor, insira uma quantidade v√°lida.");

            if (tipoAtual === 'Sa√≠da') {
                if (qtd > item.qtd) return alert("Estoque insuficiente para esta sa√≠da!");
                item.qtd -= qtd;
                const detalhe = destino === 'Caminh√£o' ? `Caminh√£o: ${ident}` : "Uso no P√°tio";
                registrarMovimentacao(item.nome, qtd, "Sa√≠da", detalhe);
            } else {
                item.qtd += qtd;
                registrarMovimentacao(item.nome, qtd, "Entrada", "Reposi√ß√£o de Estoque");
            }

            fecharModal();
            renderizar();
        }

        function remover(index) {
            if(confirm("Deseja realmente excluir este item permanentemente?")) { 
                estoque.splice(index, 1); 
                renderizar(); 
            }
        }

        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Relat√≥rio Diesel Control Pro", 14, 20);
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 28);

            doc.autoTable({
                head: [["Item", "Qtd", "Tipo", "Destino/Obs", "Data/Hora"]],
                body: historico.map(h => [h.nome, h.qtd, h.tipo, h.detalhes, `${h.data} ${h.hora}`]),
                startY: 35,
                theme: 'grid',
                headStyles: {fillColor: [31, 41, 55]}
            });
            doc.save("balanco_diesel.pdf");
        }

        // Carregamento inicial
        renderizar();
    </script>
</body>
</html>
