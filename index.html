<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diesel Control Pro - Oficina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-slate-100 p-2 md:p-8 font-sans text-slate-900">

    <div class="max-w-6xl mx-auto bg-white p-4 md:p-6 rounded-2xl shadow-2xl border border-slate-200">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b pb-6">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">üõ†Ô∏è Diesel Control <span class="text-emerald-600">Pro</span></h1>
                <p id="valorTotalPatio" class="text-sm font-bold text-emerald-600 mt-1">Carregando total...</p>
            </div>
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="fazerBackup()" class="bg-slate-800 text-white px-3 py-2 rounded-lg text-[10px] font-bold">üíæ BACKUP</button>
                <button onclick="abrirModalQR()" class="bg-purple-600 text-white px-3 py-2 rounded-lg text-[10px] font-bold">üì± GERAR QR PARA CELULAR</button>
                <button onclick="gerarPDF()" class="bg-emerald-600 text-white px-3 py-2 rounded-lg text-[10px] font-bold">üìÑ PDF NO PC</button>
            </div>
        </div>
        
        <input id="busca" oninput="renderizar()" type="text" placeholder="üîç Buscar pe√ßa..." class="w-full p-3 mb-6 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-emerald-500">

        <div class="overflow-x-auto rounded-xl border border-slate-200">
            <table class="w-full text-left">
                <thead class="bg-slate-800 text-slate-200 uppercase text-[10px] font-bold">
                    <tr>
                        <th class="p-4">Item</th>
                        <th class="p-4">Qtd</th>
                        <th class="p-4">Pre√ßo</th>
                        <th class="p-4">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="lista-estoque" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>

    <div id="modalQR" class="fixed inset-0 bg-slate-900/90 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white p-6 rounded-3xl text-center max-w-sm w-full">
            <h2 class="font-black text-xl mb-4">Escaneie com o Celular</h2>
            <div id="qrcode-container" class="flex justify-center p-4 bg-white border rounded-xl mb-4"></div>
            <p class="text-xs text-slate-500 mb-6 uppercase font-bold">Este QR cont√©m o resumo das sa√≠das do m√™s atual.</p>
            <button onclick="fecharModalQR()" class="w-full bg-slate-800 text-white p-3 rounded-xl font-bold">FECHAR</button>
        </div>
    </div>

    <div id="modalSaida" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md rounded-2xl p-6">
            <h2 id="tituloSaida" class="text-xl font-black mb-4">Sa√≠da de Pe√ßa</h2>
            <input id="qtdSaida" type="number" class="w-full p-3 border-2 rounded-xl mb-4 text-xl font-bold" value="1">
            <select id="destinoSaida" onchange="togglePlaca()" class="w-full p-3 border-2 rounded-xl mb-4 font-bold">
                <option value="P√°tio">üì¶ USO NO P√ÅTIO</option>
                <option value="Ve√≠culo">üöö VE√çCULO (CLIENTE/PLACA)</option>
            </select>
            <input id="identificacaoSaida" type="text" placeholder="PLACA OU CLIENTE" class="w-full p-3 border-2 border-emerald-500 rounded-xl mb-4 hidden font-bold uppercase">
            <button onclick="confirmarSaida()" class="w-full bg-red-600 text-white p-4 rounded-xl font-black uppercase">Confirmar Sa√≠da</button>
            <button onclick="fecharModalSaida()" class="w-full text-slate-400 mt-2 text-sm uppercase font-bold">Cancelar</button>
        </div>
    </div>

    <script>
        let estoque = JSON.parse(localStorage.getItem('meuEstoque')) || [];
        let historico = JSON.parse(localStorage.getItem('meuHistorico')) || [];
        let indexAtual = null;

        function registrar(nome, qtd, tipo, detalhes = "") {
            const agora = new Date();
            historico.push({
                data: agora.toLocaleDateString('pt-BR'),
                hora: agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
                mesAno: agora.toLocaleDateString('pt-BR', {month: '2-digit', year: 'numeric'}),
                nome: nome.toUpperCase(), qtd, tipo, detalhes: detalhes.toUpperCase()
            });
            localStorage.setItem('meuHistorico', JSON.stringify(historico));
        }

        function renderizar() {
            const lista = document.getElementById('lista-estoque');
            const busca = document.getElementById('busca').value.toLowerCase();
            let total = 0;
            lista.innerHTML = '';

            estoque.forEach((item, index) => {
                total += (item.qtd * item.preco);
                if (item.nome.toLowerCase().includes(busca)) {
                    lista.innerHTML += `
                        <tr class="hover:bg-slate-50">
                            <td class="p-4 font-bold text-xs uppercase">${item.nome}</td>
                            <td class="p-4 font-bold text-lg text-slate-600">${item.qtd}</td>
                            <td class="p-4 text-xs text-slate-500">R$ ${item.preco.toFixed(2)}</td>
                            <td class="p-4 flex gap-2">
                                <button onclick="abrirSaida(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg text-[10px] font-black">SA√çDA</button>
                                <button onclick="entradaRapida(${index})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-black">ENTRA</button>
                            </td>
                        </tr>`;
                }
            });
            document.getElementById('valorTotalPatio').innerText = `Total P√°tio: R$ ${total.toFixed(2)}`;
            localStorage.setItem('meuEstoque', JSON.stringify(estoque));
        }

        // --- FUN√á√ïES DE MOVIMENTA√á√ÉO ---
        function abrirSaida(index) {
            indexAtual = index;
            document.getElementById('tituloSaida').innerText = `Sa√≠da: ${estoque[index].nome}`;
            document.getElementById('modalSaida').classList.remove('hidden');
        }

        function togglePlaca() {
            const d = document.getElementById('destinoSaida').value;
            document.getElementById('identificacaoSaida').className = (d === 'Ve√≠culo') ? 'w-full p-3 border-2 border-emerald-500 rounded-xl mb-4 font-bold uppercase' : 'hidden';
        }

        function confirmarSaida() {
            const item = estoque[indexAtual];
            const q = parseInt(document.getElementById('qtdSaida').value);
            const d = document.getElementById('destinoSaida').value;
            const i = document.getElementById('identificacaoSaida').value;

            if (q > item.qtd) return alert("Estoque insuficiente!");
            item.qtd -= q;
            registrar(item.nome, q, "SA√çDA", d === 'Ve√≠culo' ? `VE√çCULO: ${i}` : "P√ÅTIO");
            fecharModalSaida(); renderizar();
        }

        function entradaRapida(index) {
            const q = prompt(`Entrada de "${estoque[index].nome}". Quantidade?`, "1");
            if (q && !isNaN(q)) {
                estoque[index].qtd += parseInt(q);
                registrar(estoque[index].nome, q, "ENTRADA", "REPOSI√á√ÉO");
                renderizar();
            }
        }

        function fecharModalSaida() { document.getElementById('modalSaida').classList.add('hidden'); }

        // --- FUN√á√ïES DE QR CODE ---
        function abrirModalQR() {
            const mes = new Date().toLocaleDateString('pt-BR', {month: '2-digit', year: 'numeric'});
            const rel = historico.filter(h => h.mesAno === mes).slice(-15);
            
            // Gerar texto para o QR Code
            let txt = `DIESEL CONTROL - ${mes}\n`;
            rel.forEach(h => txt += `${h.data} | ${h.tipo}: ${h.qtd} ${h.nome} (${h.detalhes})\n`);

            document.getElementById('qrcode-container').innerHTML = "";
            new QRCode(document.getElementById("qrcode-container"), {
                text: txt,
                width: 200,
                height: 200
            });
            document.getElementById('modalQR').classList.remove('hidden');
        }

        function fecharModalQR() { document.getElementById('modalQR').classList.add('hidden'); }

        function fazerBackup() {
            const b = new Blob([JSON.stringify({estoque, historico})], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `backup_oficina.json`; a.click();
        }

        function gerarPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const mes = new Date().toLocaleDateString('pt-BR', {month: '2-digit', year: 'numeric'});
            doc.text(`RELATORIO MENSAL - ${mes}`, 14, 20);
            doc.autoTable({
                head: [["Item", "Qtd", "Tipo", "Detalhe", "Data"]],
                body: historico.filter(h => h.mesAno === mes).map(h => [h.nome, h.qtd, h.tipo, h.detalhes, h.data]),
                startY: 30
            });
            doc.save(`relatorio_${mes.replace('/','_')}.pdf`);
        }

        renderizar();
    </script>
</body>
</html>
